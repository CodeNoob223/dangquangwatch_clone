<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/images/LogoMobile.png">
  <title th:text="${session.hoten}"></title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
  <link rel="stylesheet" th:href="@{/css/application.css}">
</head>

<body class="bg-slate-200 overflow-x-hidden">
  <div th:replace="~{fragments/header :: header}"></div>
  <div th:replace="~{fragments/productsbar :: productsbar}"></div>
  <div class="w-full xl:max-w-[1215px] max-w-[1021px] mx-auto my-9 min-h-[85vh]">
    <div class="flex gap-2 w-max mx-auto items-end">
      <h1 class="p-2 bg-white rounded-tl rounded-tr text-xl text-yellow-500 font-bold underline"><a
          href="/profile/doithongtin">Đổi thông tin</a></h1>
      <h1 class="p-2 bg-slate-400 rounded-tl rounded-tr text-xl hover:text-yellow-500"><a href="/profile/donhang">Đơn
          hàng</a></h1>
      <h1 class="p-2 bg-slate-400 rounded-tl rounded-tr text-xl hover:text-yellow-500"><a href="/profile/giohang">Giỏ
          hàng</a></h1>
    </div>
    <div class="bg-white shadow-md rounded-lg overflow-hidden p-4 min-h-[800px]">
      <form class="mx-auto w-full" onsubmit="handleSubmit(event)" th:object="${taikhoan}" action="/profile/doithongtin"
        method="post">
        <input type="text" class="hidden" th:value="${username}" name="username">
        <section>
          <label class="block font-medium">Nhập mã xác thực</label>
          <div class="flex gap-1">
            <input id="d1" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d1" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />
            <input id="d2" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d2" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />
            <input id="d3" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d3" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />
            <input id="d4" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d4" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />
            <input id="d5" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d5" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />
            <input id="d6" class="border border-black rounded block p-2 w-7" type="text" maxlength="1"  name="d6" placeholder="X" autocomplete="off" onkeypress='validate(event)' required />        
          </div>
          <p>Chúng tôi đã gửi mã xác thực tới <span th:text="${newphonenumber}"></span></p>
          <button id="sendbtn" class="p-2 w-max bg-blue-500 hover:bg-blue-600 rounded block mt-4 text-white">
            Xác thực
          </button>
          <div id="waitbtn" class="p-2 w-max bg-slate-500 rounded block mt-4 text-white cursor-wait" style="display: none;">
            Xác thực
          </div> 
        </section>
      </form>
    </div>
  </div>

  <div th:replace="~{fragments/footer :: footer}"></div>
  <script>
    function validate(evt) {
      if (evt.key == "Backspace" || evt.key == "Del") return true;

      var theEvent = evt || window.event;

      // Handle paste
      if (theEvent.type === 'paste') {
        key = event.clipboardData.getData('text/plain');
      } else {
        // Handle key press
        var key = theEvent.keyCode || theEvent.which;
        key = String.fromCharCode(key);
      }
      var regex = /[0-9]|\./;
      if (!regex.test(key)) {
        theEvent.returnValue = false;
        if (theEvent.preventDefault) theEvent.preventDefault();
      }
    }
  </script>
  <script th:inline="javascript">
    const errorMessage = /*[[${errorMessage}]]*/ '';
    if (errorMessage) {
      showNotification(
        {
          title: "Lỗi",
          message: errorMessage,
          type: "error"
        }
      );
    }

    const notifMessage = /*[[${notification}]]*/ '';
    if (notifMessage) {
      showNotification(
        {
          title: "Thông báo",
          message: notifMessage,
          type: "info"
        }
      );
    }
  </script>
  <script th:inline="javascript">
    const username = /*[[${username}]]*/ '';
    const newphonenumber = /*[[${newphonenumber}]]*/ '';
    let otp6digit = "";
    const sendBtn = document.getElementById("sendbtn");
    const waitBtn = document.getElementById("waitbtn");

    const d1 = document.getElementById("d1");
    const d2 = document.getElementById("d2");
    const d3 = document.getElementById("d3");
    const d4 = document.getElementById("d4");
    const d5 = document.getElementById("d5");
    const d6 = document.getElementById("d6");

    d1.addEventListener("input", () => {
      if (d1.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        d2.focus();
      }
    });
    d2.addEventListener("input", () => {
      if (d2.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        d3.focus();
      }
    });
    d3.addEventListener("input", () => {
      if (d3.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        d4.focus();
      }
    });
    d4.addEventListener("input", () => {
      if (d4.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        d5.focus();
      }
    });
    d5.addEventListener("input", () => {
      if (d5.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        d6.focus();
      } 
    });
    d6.addEventListener("input", () => {
      if (d6.value.length > 0) {
        otp6digit = d1.value + d2.value + d3.value + d4.value + d5.value + d6.value;
        sendBtn.focus();
      }
    });

    function handleSubmit(event) {
      event.preventDefault();
      sendBtn.style.display = "none";
      waitBtn.style.display = "block";
      const form = event.target;
      const data = new FormData(form);

      fetch(`/otp/vn?e=${username}&n=${newphonenumber}&p=${otp6digit}`, {
        headers: {
          'Content-Type': 'application/json'
        },
        method: "GET"
      })
        .then(response => response.json())
        .then(data => {
          if (data.status) {
            showNotification(
              {
                title: "Thông báo",
                message: "Đổi số điện thoại thành công!",
                type: "success"
              }
            );
            setTimeout(() => {
              window.location.href = "/profile/doithongtin";
            }, 3000);
          } else {
            sendBtn.style.display = "block";
            waitBtn.style.display = "none";
            showNotification(
              {
                title: "Lỗi",
                message: data.message,
                type: "error"
              }
            );
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
  </script>
</body>

</html>